{"version":3,"file":"content-script.js","mappings":"mBAKO,SAASA,EAASC,GACrB,OAAQA,GAAwB,iBAATA,IAAsBC,MAAMC,QAAQF,EAC/D,CAOO,SAASG,EAAUC,KAAWC,GACjC,IAAKA,EAAQC,OAAQ,OAAOF,EAC5B,MAAMG,EAASF,EAAQG,QAEvB,GAAIT,EAASK,IAAWL,EAASQ,GAC7B,IAAK,MAAME,KAAOF,EACVR,EAASQ,EAAOE,KACXL,EAAOK,IAAMC,OAAOC,OAAOP,EAAQ,CAAE,CAACK,GAAM,CAAC,IAClDN,EAAUC,EAAOK,GAAMF,EAAOE,KAE9BC,OAAOC,OAAOP,EAAQ,CAAE,CAACK,GAAMF,EAAOE,KAKlD,OAAON,EAAUC,KAAWC,EAChC,CC9BO,SAASO,EAAuBC,EAAcC,GACjD,MAAMR,EAASQ,EAAaD,EACtBE,EAAU,IAAIC,WAAWC,WAAWC,OAAQL,EAAcP,GAE1Da,EAAe,IAAIC,YAAY,SAASC,OAAON,GACrDO,KAAKC,OAAOC,KAAK,eAAeT,EAAQU,KAAK,UAAUN,IAC3D,CCNO,SAASO,EAAuBC,GACnC,MAAMC,EAAW,IAAIC,SAASZ,WAAWC,QACnCY,EAAoBF,EAASG,UAAUJ,GAAK,GAE5CK,EADcJ,EAASG,UAAUJ,EAAM,GAAG,GACZG,EAC9Bf,EAAU,IAAIC,WAAWC,WAAWC,OAAQY,EAAmBE,GAE/Db,EAAe,IAAIC,YAAY,SAASC,OAAON,GACrDO,KAAKC,OAAOC,KAAK,cAAcT,EAAQU,KAAK,UAAUN,IAC1D,CCFA,SAASc,EAAeC,EAAQC,EAAMC,EAAQC,GAC1C,OAAOH,EAAOI,eAAe,CACzBC,UAAW,MACXC,SAAUL,EACVM,KAAM,OACNC,KAAMR,EAAOS,aAAa,CACtBC,KAAM,OACNR,OAAQA,EACRC,WAAYA,KAGxB,CCfA,SAASQ,EAAmBC,GACxB,OAAOC,eAAeC,EAAcC,EAAe,CAAC,GAChD3B,KAAKC,OAAOC,KAAK,yCAEjB,MAAM0B,EDaC,SAA0BC,GACrC,MAAMjB,EAAS,IAAIkB,WAAWD,GACxBE,EAAU,CAAEC,IAAK,CAAC,GAWxB,OATAD,EAAQC,IAAIC,eAAiB7B,EDb1B,SAAgCQ,EAAQsB,GAC3CtB,EAAOuB,qBAAqB,MAAM,UAAU,MAAEC,IAC1C,MAAMC,EAAS,IAAIC,aAAaF,GAWhC,OARAC,EAAOE,WAAW,CAAEC,eACpBH,EAAOE,WAAWE,UAAU,IAE5BJ,EAAOE,WAAW,CAAEG,UACpBL,EAAOE,WAAWL,EAAQS,aAG1BN,EAAOE,WAAWH,GACXC,EAAOO,OAClB,GACJ,CCAIC,CAAuBjC,EADGD,EAAeC,EAAQ,iBAAkB,CAAC,SAGpEmB,EAAQC,IAAIc,eAAiBxD,EFpB1B,SAAgCsB,EAAQsB,GAC3CtB,EAAOuB,qBAAqB,MAAM,UAAU,MAAEC,IAC1C,MAAMC,EAAS,IAAIC,aAAaF,GAqBhC,OAlBAC,EAAOE,WAAWH,EAAMW,SAAS,EAAGX,EAAMpD,OAAS,IASnDqD,EAAOE,WAAW,CAAEC,eACpBH,EAAOE,WAAWE,UAAU,IAC5BJ,EAAOE,WAAW,CAAEC,eACpBH,EAAOE,WAAWE,UAAU,IAC5BJ,EAAOE,WAAW,CAAEG,UACpBL,EAAOE,WAAWL,EAAQS,aAE1BN,EAAOE,WAAW,CAAES,SAEbX,EAAOO,OAClB,GACJ,CEHIK,CAAuBrC,EADGD,EAAeC,EAAQ,iBAAkB,CAAC,MAAO,SAG3EA,EAAOsC,QA7BX,SAA2BnB,EAASF,GAChC,MAAO,CAAEE,UAASF,SACtB,CA4BWD,CAAkBG,EAASnB,EAAOgC,QAC7C,CC3BkCO,CAAiBzB,GAK3C,OAJIE,EAAkBG,UAClBJ,EAAe9C,EAAU8C,EAAcC,EAAkBG,UAGtDP,EAASI,EAAkBC,OAAQF,EAC9C,CACJ,CCdAF,eAAe2B,IACX,GAAIC,qBAAqBC,QAErB,aADkBD,WACPE,cACR,GAAIF,qBAAqBG,SAC5B,aAAaH,UAAUE,cAEvB,MAAM,IAAIE,MAAM,mFAExB,CCLA,MAAMxD,EAAS,ICJA,MACX,WAAAyD,CAAYC,EAAYC,EAAaC,GACjCC,KAAKH,WAAaA,GAAcI,QAAQC,IACxCF,KAAKF,YAAcA,GAAeG,QAAQE,MAC1CH,KAAKD,YAAcA,GAAeE,QAAQG,MAE1C,MAAMC,EAAc,CAChB,mBACA,oBACA,6BACFhE,KAAK,KAEP2D,KAAK5D,KAAO4D,KAAKH,WAAWS,KAAKL,QAAS,sBAAuBI,EAAa,IAC9EL,KAAKG,MAAQH,KAAKF,YAAYQ,KAAKL,QAAS,uBAAwBI,EAAa,IACjFL,KAAKI,MAAQJ,KAAKD,YAAYO,KAAKL,QAAS,uBAAwBI,EAAa,GACrF,GDVJE,OAAOrE,KAAO,CACVC,UELAD,KAAKC,OAAOgE,MAAM,kDAElBI,OAAOC,UAAYC,SACnBF,OAAOE,SAAW,WACdF,OAAOG,EAAKC,GAAOA,EAAI,IAAM,OAAW,KACxCzE,KAAKC,OAAOgE,MAAM,+BAClB,MAAMS,EAAKL,OAAOC,UAAUK,MAAMb,KAAMc,WAExC,OADAP,OAAOE,SAAWF,OAAOC,UAClBI,CACX,ECNA1E,KAAKC,OAAOC,KAAK,0BLYN,WACX,MACM2E,EAAOtD,EADOuD,YAAYC,aAEhCV,OAAOS,YAAYC,YAAcF,CACrC,CKfIG,GJeoBF,YAAYG,qBAEhCZ,OAAOS,YAAYG,qBAVZxD,eAAe4B,EAAW1B,EAAe,CAAC,GAC7C3B,KAAKC,OAAOC,KAAK,kDACjB,MAAMN,QAAewD,IACrB,OAAO0B,YAAYC,YAAYnF,EAAQ+B,EAC3C,C","sources":["webpack:///./src/shared/utils/merge.js","webpack:///./src/content-script/instrument/decryption.js","webpack:///./src/content-script/instrument/encryption.js","webpack:///./src/content-script/instrument/index.js","webpack:///./src/content-script/wasm-trigger/instantiate.js","webpack:///./src/content-script/wasm-trigger/instantiateStreaming.js","webpack:///./src/content-script/index.js","webpack:///./src/shared/utils/log.js","webpack:///./src/content-script/debugger-protection.js","webpack:///./src/content-script/wasm-trigger/index.js"],"sourcesContent":["/**\n * Simple object check.\n * @param item\n * @returns {boolean}\n */\nexport function isObject(item) {\n    return (item && typeof item === 'object' && !Array.isArray(item));\n}\n\n/**\n * Deep merge two objects.\n * @param target\n * @param ...sources\n */\nexport function mergeDeep(target, ...sources) {\n    if (!sources.length) return target;\n    const source = sources.shift();\n\n    if (isObject(target) && isObject(source)) {\n        for (const key in source) {\n            if (isObject(source[key])) {\n                if (!target[key]) Object.assign(target, { [key]: {} });\n                mergeDeep(target[key], source[key]);\n            } else {\n                Object.assign(target, { [key]: source[key] });\n            }\n        }\n    }\n\n    return mergeDeep(target, ...sources);\n}","export function decryptionFunctionHook(beginAddress, endAddress) {\r\n    const length = endAddress - beginAddress;\r\n    const message = new Uint8Array(wasmMemory.buffer, beginAddress, length);\r\n\r\n    const messageAscii = new TextDecoder(\"ascii\").decode(message);\r\n    wyff.logger.info(`RECEIVED\\t\\t${message.join(\"\\t\")}\\n${messageAscii}`);\r\n}\r\n\r\nexport function hookDecryptionFunction(parser, hookRef) {\r\n    parser.addCodeElementParser(2644, function ({ bytes }) {\r\n        const reader = new BufferReader(bytes);\r\n\r\n        // push the original function without the last END byte\r\n        reader.copyBuffer(bytes.subarray(0, bytes.length - 1));\r\n\r\n        /**\r\n         * I think the address for the beginning of the decrpyted payload\r\n         * is located at var2+20. so &var2+20 = length byte for the message.\r\n         * (&var2+20)+4 is the first byte of the message\r\n         */\r\n\r\n        // Get var 2 and call decryption hook\r\n        reader.copyBuffer([ OP_GET_LOCAL ]);\r\n        reader.copyBuffer(VarUint32(0x00));\r\n        reader.copyBuffer([ OP_GET_LOCAL ]);\r\n        reader.copyBuffer(VarUint32(0x01));\r\n        reader.copyBuffer([ OP_CALL ]);\r\n        reader.copyBuffer(hookRef.varUint32());\r\n\r\n        reader.copyBuffer([ OP_END ]);\r\n\r\n        return reader.write();\r\n    });\r\n}","export function encryptionFunctionHook(ptr) {\n    const dataview = new DataView(wasmMemory.buffer);\n    const beginningOfMsgPtr = dataview.getUint32(ptr, true);\n    const endOfMsgPtr = dataview.getUint32(ptr + 4, true);\n    const messageLength = endOfMsgPtr - beginningOfMsgPtr;\n    const message = new Uint8Array(wasmMemory.buffer, beginningOfMsgPtr, messageLength);\n\n    const messageAscii = new TextDecoder(\"ascii\").decode(message);\n    wyff.logger.info(`SENDING\\t\\t${message.join(\"\\t\")}\\n${messageAscii}`);\n}\n\nexport function hookEncryptionFunction(parser, hookRef) {\n    parser.addCodeElementParser(2657, function ({ bytes }) {\n        const reader = new BufferReader(bytes);\n\n        // push the first arg of the function onto the stack\n        reader.copyBuffer([ OP_GET_LOCAL ]);\n        reader.copyBuffer(VarUint32(0x00));\n        // call the hook function\n        reader.copyBuffer([ OP_CALL ]);\n        reader.copyBuffer(hookRef.varUint32());\n\n        // push the rest of the function\n        reader.copyBuffer(bytes);\n        return reader.write();\n    });\n}","import { decryptionFunctionHook, hookDecryptionFunction } from \"./decryption.js\";\nimport { encryptionFunctionHook, hookEncryptionFunction } from \"./encryption\";\n\nfunction instrumentResults(imports, binary) {\n    return { imports, binary };\n}\n\nfunction importFunction(parser, name, params, returnType) {\n    return parser.addImportEntry({\n        moduleStr: \"env\",\n        fieldStr: name,\n        kind: \"func\",\n        type: parser.addTypeEntry({\n            form: \"func\",\n            params: params,\n            returnType: returnType\n        })\n    });\n}\n\nexport default function instrumentBinary(binary) {\n    const parser = new WailParser(binary);\n    const imports = { env: {} };\n\n    imports.env.encryptionHook = encryptionFunctionHook;\n    const encryptionHookRef = importFunction(parser, \"encryptionHook\", [\"i32\"]);\n    hookEncryptionFunction(parser, encryptionHookRef);\n\n    imports.env.decryptionHook = decryptionFunctionHook;\n    const decryptionHookRef = importFunction(parser, \"decryptionHook\", [\"i32\", \"i32\"]);\n    hookDecryptionFunction(parser, decryptionHookRef);\n\n    parser.parse();\n    return instrumentResults(imports, parser.write());\n}","import { mergeDeep } from \"../../shared/utils/merge\";\nimport instrumentBinary from \"../instrument\";\n\nfunction createHookFunction(original) {\n    return async function(bufferSource, importObject = {}) {\n        wyff.logger.info(\"WebAssembly.instantiate() intercepted\");\n\n        const instrumentResults = instrumentBinary(bufferSource);\n        if (instrumentResults.imports) {\n            importObject = mergeDeep(importObject, instrumentResults.imports);\n        }\n\n        return original(instrumentResults.binary, importObject);\n    };\n}\n\nexport default function hookInstantiate() {\n    const oldFunction = WebAssembly.instantiate;\n    const hook = createHookFunction(oldFunction);\n    window.WebAssembly.instantiate = hook;\n}\n","async function getSourceBuffer() {\n    if (sourceObj instanceof Promise) {\n        const res = await sourceObj;\n        return res.arrayBuffer()\n    } else if (sourceObj instanceof Response) {\n        return await sourceObj.arrayBuffer();\n    } else {\n        throw new Error(\"Got unexpected object type as first argument to WebAssembly.instantiateStreaming\");\n    }\n}\n\nfunction createHookFunction(original) {\n    return async function(sourceObj, importObject = {}) {\n        wyff.logger.info(\"WebAssembly.instantiateStreaming() intercepted\");\n        const buffer = await getSourceBuffer(sourceObj);\n        return WebAssembly.instantiate(buffer, importObject);\n    };\n}\n\nexport default function hookInstantiateStreaming() {\n    const oldFunction = WebAssembly.instantiateStreaming;\n    const hook = createHookFunction(oldFunction);\n    window.WebAssembly.instantiateStreaming = hook;\n}\n","import Log from \"../shared/utils/log.js\";\nimport removeDebuggerProtection from \"./debugger-protection.js\";\nimport hookWASMTriggerFunctions from \"./wasm-trigger/index.js\";\n\nconst logger = new Log();\nwindow.wyff = {\n    logger,\n};\n\nremoveDebuggerProtection();\nhookWASMTriggerFunctions();","export default class Log {\n    constructor(infoWriter, debugWriter, errorWriter) {\n        this.infoWriter = infoWriter || console.log;\n        this.debugWriter = debugWriter || console.debug;\n        this.errorWriter = errorWriter || console.error;\n\n        const prefixStyle = [\n            \"font-size: 1.6em\",\n            \"font-weight: bold\",\n            \"text-transform: uppercase\",\n        ].join(\";\");\n\n        this.info = this.infoWriter.bind(console, \"%c[WYFF]%c INFO\\t%s\", prefixStyle, \"\");\n        this.debug = this.debugWriter.bind(console, \"%c[WYFF]%c DEBUG\\t%s\", prefixStyle, \"\");\n        this.error = this.errorWriter.bind(console, \"%c[WYFF]%c ERROR\\t%s\", prefixStyle, \"\");\n    }\n}\n","export default function removeDebuggerProtection(logger) {\n    wyff.logger.debug(`hooking function to remove debugger protection`);\n\n    window._Function = Function;\n    window.Function = function() {\n        window.c = (a) => (a ? () => () => {} : null);\n        wyff.logger.debug(`debugger protection removed`);\n        const fn = window._Function.apply(this, arguments);\n        window.Function = window._Function;\n        return fn;\n    };\n}","import hookInstantiate from \"./instantiate.js\";\nimport hookInstantiateStreaming from \"./instantiateStreaming.js\";\n\nexport default function hookWASMTriggerFunctions() {\n    wyff.logger.info(`hooking WASM functions`);\n    hookInstantiate();\n    hookInstantiateStreaming();\n}"],"names":["isObject","item","Array","isArray","mergeDeep","target","sources","length","source","shift","key","Object","assign","decryptionFunctionHook","beginAddress","endAddress","message","Uint8Array","wasmMemory","buffer","messageAscii","TextDecoder","decode","wyff","logger","info","join","encryptionFunctionHook","ptr","dataview","DataView","beginningOfMsgPtr","getUint32","messageLength","importFunction","parser","name","params","returnType","addImportEntry","moduleStr","fieldStr","kind","type","addTypeEntry","form","createHookFunction","original","async","bufferSource","importObject","instrumentResults","binary","WailParser","imports","env","encryptionHook","hookRef","addCodeElementParser","bytes","reader","BufferReader","copyBuffer","OP_GET_LOCAL","VarUint32","OP_CALL","varUint32","write","hookEncryptionFunction","decryptionHook","subarray","OP_END","hookDecryptionFunction","parse","instrumentBinary","getSourceBuffer","sourceObj","Promise","arrayBuffer","Response","Error","constructor","infoWriter","debugWriter","errorWriter","this","console","log","debug","error","prefixStyle","bind","window","_Function","Function","c","a","fn","apply","arguments","hook","WebAssembly","instantiate","hookInstantiate","instantiateStreaming"],"sourceRoot":""}