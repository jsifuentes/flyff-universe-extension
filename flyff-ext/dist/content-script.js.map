{"version":3,"file":"content-script.js","mappings":"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","sources":["webpack:///./src/shared/utils/merge.js","webpack:///./src/content-script/instrument/encryption.js","webpack:///./src/content-script/wasm-trigger/instantiate.js","webpack:///./src/content-script/instrument/index.js","webpack:///./src/content-script/wasm-trigger/instantiateStreaming.js","webpack:///./src/content-script/index.js","webpack:///./src/shared/utils/log.js","webpack:///./src/content-script/debugger-protection.js","webpack:///./src/content-script/wasm-trigger/index.js"],"sourcesContent":["/**\n * Simple object check.\n * @param item\n * @returns {boolean}\n */\nexport function isObject(item) {\n    return (item && typeof item === 'object' && !Array.isArray(item));\n}\n\n/**\n * Deep merge two objects.\n * @param target\n * @param ...sources\n */\nexport function mergeDeep(target, ...sources) {\n    if (!sources.length) return target;\n    const source = sources.shift();\n\n    if (isObject(target) && isObject(source)) {\n        for (const key in source) {\n            if (isObject(source[key])) {\n                if (!target[key]) Object.assign(target, { [key]: {} });\n                mergeDeep(target[key], source[key]);\n            } else {\n                Object.assign(target, { [key]: source[key] });\n            }\n        }\n    }\n\n    return mergeDeep(target, ...sources);\n}","export function encryptionFunctionHook(ptr) {\n    const dataview = new DataView(wasmMemory.buffer);\n    const beginningOfMsgPtr = dataview.getUint32(ptr, true);\n    const endOfMsgPtr = dataview.getUint32(ptr + 4, true);\n    const messageLength = endOfMsgPtr - beginningOfMsgPtr;\n    const message = new Uint8Array(wasmMemory.buffer, beginningOfMsgPtr, messageLength);\n\n    const messageAscii = new TextDecoder(\"ascii\").decode(message);\n    wyff.logger.info(`Sending message to server: ${messageAscii} [${message.join(\"\\t\")}]`);\n}\n\nexport function hookEncryptionFunction(parser, hookRef) {\n    parser.addCodeElementParser(2656, function ({ bytes }) {\n        const reader = new BufferReader(bytes);\n\n        // push the first arg of the function onto the stack\n        reader.copyBuffer([ OP_GET_LOCAL ]);\n        reader.copyBuffer(VarUint32(0x00));\n        // call the hook function\n        reader.copyBuffer([ OP_CALL ]);\n        reader.copyBuffer(hookRef.varUint32());\n\n        // push the rest of the function\n        reader.copyBuffer(bytes);\n        return reader.write();\n    });\n}","import { mergeDeep } from \"../../shared/utils/merge\";\nimport instrumentBinary from \"../instrument\";\n\nfunction createHookFunction(original) {\n    return async function(bufferSource, importObject = {}) {\n        wyff.logger.info(\"WebAssembly.instantiate() intercepted\");\n\n        const instrumentResults = instrumentBinary(bufferSource);\n        if (instrumentResults.imports) {\n            importObject = mergeDeep(importObject, instrumentResults.imports);\n        }\n\n        return original(instrumentResults.binary, importObject);\n    };\n}\n\nexport default function hookInstantiate() {\n    const oldFunction = WebAssembly.instantiate;\n    const hook = createHookFunction(oldFunction);\n    window.WebAssembly.instantiate = hook;\n}\n","import { encryptionFunctionHook, hookEncryptionFunction } from \"./encryption\";\n\nfunction instrumentResults(imports, binary) {\n    return { imports, binary };\n}\n\nfunction importFunction(parser, name, params, returnType) {\n    return parser.addImportEntry({\n        moduleStr: \"env\",\n        fieldStr: name,\n        kind: \"func\",\n        type: parser.addTypeEntry({\n            form: \"func\",\n            params: params,\n            returnType: returnType\n        })\n    });\n}\n\nexport default function instrumentBinary(binary) {\n    const parser = new WailParser(binary);\n    const imports = { env: {} };\n\n    imports.env.encryptionHook = encryptionFunctionHook;\n    const encryptionHookRef = importFunction(parser, \"encryptionHook\", [\"i32\"]);\n    hookEncryptionFunction(parser, encryptionHookRef);\n\n    parser.parse();\n    return instrumentResults(imports, parser.write());\n}","async function getSourceBuffer() {\n    if (sourceObj instanceof Promise) {\n        const res = await sourceObj;\n        return res.arrayBuffer()\n    } else if (sourceObj instanceof Response) {\n        return await sourceObj.arrayBuffer();\n    } else {\n        throw new Error(\"Got unexpected object type as first argument to WebAssembly.instantiateStreaming\");\n    }\n}\n\nfunction createHookFunction(original) {\n    return async function(sourceObj, importObject = {}) {\n        wyff.logger.info(\"WebAssembly.instantiateStreaming() intercepted\");\n        const buffer = await getSourceBuffer(sourceObj);\n        return WebAssembly.instantiate(buffer, importObject);\n    };\n}\n\nexport default function hookInstantiateStreaming() {\n    const oldFunction = WebAssembly.instantiateStreaming;\n    const hook = createHookFunction(oldFunction);\n    window.WebAssembly.instantiateStreaming = hook;\n}\n","import Log from \"../shared/utils/log.js\";\nimport removeDebuggerProtection from \"./debugger-protection.js\";\nimport hookWASMTriggerFunctions from \"./wasm-trigger/index.js\";\n\nconst logger = new Log();\nwindow.wyff = {\n    logger,\n};\n\nremoveDebuggerProtection();\nhookWASMTriggerFunctions();","export default class Log {\n    constructor(infoWriter, debugWriter, errorWriter) {\n        this.infoWriter = infoWriter || console.log;\n        this.debugWriter = debugWriter || console.debug;\n        this.errorWriter = errorWriter || console.error;\n\n        const prefixStyle = [\n            \"font-size: 1.6em\",\n            \"font-weight: bold\",\n            \"text-transform: uppercase\",\n        ].join(\";\");\n\n        this.info = this.infoWriter.bind(console, \"%c[WYFF]%c INFO\\t%s\", prefixStyle, \"\");\n        this.debug = this.debugWriter.bind(console, \"%c[WYFF]%c DEBUG\\t%s\", prefixStyle, \"\");\n        this.error = this.errorWriter.bind(console, \"%c[WYFF]%c ERROR\\t%s\", prefixStyle, \"\");\n    }\n}\n","export default function removeDebuggerProtection(logger) {\n    wyff.logger.debug(`hooking function to remove debugger protection`);\n\n    window._Function = Function;\n    window.Function = function() {\n        window.c = (a) => (a ? () => () => {} : null);\n        wyff.logger.debug(`debugger protection removed`);\n        const fn = window._Function.apply(this, arguments);\n        window.Function = window._Function;\n        return fn;\n    };\n}","import hookInstantiate from \"./instantiate.js\";\nimport hookInstantiateStreaming from \"./instantiateStreaming.js\";\n\nexport default function hookWASMTriggerFunctions() {\n    wyff.logger.info(`hooking WASM functions`);\n    hookInstantiate();\n    hookInstantiateStreaming();\n}"],"names":["isObject","item","Array","isArray","mergeDeep","target","sources","length","source","shift","key","Object","assign","encryptionFunctionHook","ptr","dataview","DataView","wasmMemory","buffer","beginningOfMsgPtr","getUint32","messageLength","message","Uint8Array","messageAscii","TextDecoder","decode","wyff","logger","info","join","createHookFunction","original","async","bufferSource","importObject","instrumentResults","binary","parser","WailParser","imports","env","encryptionHook","encryptionHookRef","name","params","returnType","addImportEntry","moduleStr","fieldStr","kind","type","addTypeEntry","form","importFunction","hookRef","addCodeElementParser","bytes","reader","BufferReader","copyBuffer","OP_GET_LOCAL","VarUint32","OP_CALL","varUint32","write","hookEncryptionFunction","parse","instrumentBinary","getSourceBuffer","sourceObj","Promise","arrayBuffer","Response","Error","constructor","infoWriter","debugWriter","errorWriter","this","console","log","debug","error","prefixStyle","bind","window","_Function","Function","c","a","fn","apply","arguments","hook","WebAssembly","instantiate","hookInstantiate","instantiateStreaming"],"sourceRoot":""}